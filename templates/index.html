<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Envio de Conta e Geração de Lead</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; display: flex; gap: 20px; margin: 20px; }
        .col { flex: 1; }
        .pdf-preview { height: 500px; width: 100%; }
    </style>
</head>
<body>
<div class="col">
    <h3>1. Dados extraídos automaticamente</h3>
    Nome:<input id="nome" type="text"><br>
    Email:<input id="email" type="email"><br>
    Telefone:<input id="telefone" type="text"><br>
    CPF:<input id="cpf" type="text"><br>
    Cidade:<input id="cidade" type="text"><br>
    CEP:<input id="cep" type="text"><br>
    Rua:<input id="rua" type="text"><br>
    Número:<input id="numero" type="text"><br>

    <h3>2. Consumo dos últimos 12 meses</h3>
    <canvas id="graficoConsumo" height="200"></canvas>
    Média de consumo:<input id="media" type="text"><br>
</div>
<div class="col">
    <h3>3. PDF da conta</h3>
    <div id="drop_zone" style="border:2px dashed #00f; padding:20px; text-align:center;">
        Arraste ou clique aqui para enviar o PDF
        <input type="file" id="fileInput" accept=".pdf" hidden>
    </div>
    <iframe id="pdfView" class="pdf-preview"></iframe>
    <button onclick="criarLead()">Criar Lead</button>
    <p id="atualizado"></p>
</div>

<script>
document.getElementById('drop_zone').addEventListener('click', () => document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', enviarArquivo);

function enviarArquivo(e) {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    fetch('/upload', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            document.getElementById('nome').value = data.nome;
            document.getElementById('cpf').value = data.cpf;
            document.getElementById('cidade').value = data.cidade;
            document.getElementById('cep').value = data.cep;
            document.getElementById('rua').value = data.rua;
            document.getElementById('numero').value = data.numero;
            document.getElementById('media').value = data.consumo_medio;
            document.getElementById('atualizado').innerText = "Atualizado em: " + data.atualizado_em;

            document.getElementById('pdfView').src = "/pdf/" + data.arquivo;

            const ctx = document.getElementById('graficoConsumo').getContext('2d');
            const labels = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.slice(-data.consumos.length),
                    datasets: [{
                        label: 'Consumo (kWh)',
                        data: data.consumos,
                        backgroundColor: '#2196F3'
                    }]
                },
                options: {
                    plugins: {
                        tooltip: { enabled: true },
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        });
}

function criarLead() {
    alert("Lead criado com sucesso!");
}
</script>
</body>
</html>
