<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Extrator de Contas - Inntag</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      display: flex;
      gap: 20px;
    }
    #left, #right {
      flex: 1;
    }
    input, button {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }
    pre {
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="left">
    <h2>ğŸ” Dados extraÃ­dos da conta</h2>
    <label>Nome:<input id="nome" /></label>
    <label>CPF:<input id="cpf" /></label>
    <label>Cidade:<input id="cidade" /></label>
    <label>CEP:<input id="cep" /></label>
    <label>Rua:<input id="rua" /></label>
    <label>NÃºmero:<input id="numero" /></label>
    <label>Consumo mÃ©dio:<input id="consumo_medio" /></label>

    <canvas id="chart" width="400" height="200" style="margin-top:10px;"></canvas>

    <h3>ğŸ§ª Log da extraÃ§Ã£o</h3>
    <pre id="log-output">Aguardando upload...</pre>
  </div>

  <div id="right">
    <h2>ğŸ“ Upload da conta em PDF</h2>
    <input type="file" id="upload" accept="application/pdf" />
    <button onclick="enviar()">ğŸ“¤ Enviar Lead via Webhook</button>

    <iframe id="preview" width="100%" height="500" style="border:1px solid #ddd; margin-top:10px;"></iframe>
  </div>

  <script>
    function renderChart(data) {
      if (!window.Chart) return;
      new Chart(document.getElementById("chart"), {
        type: "bar",
        data: {
          labels: [
            "Jan", "Fev", "Mar", "Abr", "Mai", "Jun",
            "Jul", "Ago", "Set", "Out", "Nov", "Dez"
          ],
          datasets: [{
            label: "Consumo (kWh)",
            data,
            backgroundColor: "#2c3e50"
          }]
        }
      });
    }

    document.getElementById("upload").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const form = new FormData();
      form.append("file", file);

      const res = await fetch("/upload", {
        method: "POST",
        body: form
      });
      const data = await res.json();

      // Preencher campos
      for (let campo of ["nome", "cpf", "cidade", "cep", "rua", "numero", "consumo_medio"]) {
        document.getElementById(campo).value = data[campo] || "";
      }

      // Preencher grÃ¡fico
      renderChart(data.consumos || []);

      // Mostrar log
      document.getElementById("log-output").innerText = (data.log || []).join("\\n");

      // VisualizaÃ§Ã£o do PDF
      const blob = new Blob([file], { type: file.type });
      document.getElementById("preview").src = URL.createObjectURL(blob);
    });

    async function enviar() {
      const campos = ["nome", "cpf", "cidade", "cep", "rua", "numero", "consumo_medio"];
      const dados = campos.reduce((acc, id) => {
        acc[id] = document.getElementById(id).value;
        return acc;
      }, {});

      const res = await fetch("/send-webhook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados),
      });

      alert("Lead enviado com status: " + res.status);
    }
  </script>
</body>
</html>
