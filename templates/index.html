<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Envio de Conta e Geração de Lead</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; }
    .dropzone { border: 2px dashed #3f83f8; padding: 40px; text-align: center; color: #3f83f8;
                cursor: pointer; border-radius: 4px; margin-bottom: 10px; }
    label { display: block; margin-bottom: 8px; }
    input { width: 100%; padding: 6px; margin-top: 2px; margin-bottom: 12px; }
    #criar { margin-top: 10px; padding: 8px 16px; }
    canvas { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <h2>Envio de Conta e Geração de Lead</h2>
  <div class="container">
    <div class="box">
      <h3>1. Dados extraídos automaticamente</h3>
      <label>Nome:<input id="nome" readonly></label>
      <label>Email:<input id="email"></label>
      <label>Telefone:<input id="telefone"></label>
      <label>CPF:<input id="cpf" readonly></label>
      <label>Cidade:<input id="cidade" readonly></label>
      <label>CEP:<input id="cep" readonly></label>
      <label>Rua:<input id="rua" readonly></label>
      <label>Número:<input id="numero" readonly></label>

      <h3>2. Consumo dos últimos 12 meses</h3>
      <canvas id="chart"></canvas>
      <label>Média de consumo:<input id="media" readonly></label>
    </div>
    <div class="box">
      <h3>3. PDF da conta</h3>
      <div id="dropzone" class="dropzone">Arraste ou clique aqui para enviar o PDF</div>
      <iframe id="pdf-preview" style="width:100%;height:400px;border:1px solid #ccc;
                border-radius:4px;margin-bottom:10px"></iframe>
      <button id="criar">Criar Lead</button>
      <div id="timestamp" style="margin-top:10px;font-size:0.9em;color:#555"></div>
    </div>
  </div>

  <script>
    const drop = document.getElementById('dropzone');
    const fileInput = document.createElement('input');
    fileInput.type = 'file'; fileInput.accept = 'application/pdf';
    drop.onclick = () => fileInput.click();
    drop.ondrop = e => { e.preventDefault(); fileInput.files = e.dataTransfer.files; handleFile(); };
    drop.ondragover = e => e.preventDefault();
    fileInput.onchange = handleFile;

    function handleFile(){
      const file = fileInput.files[0];
      if(!file) return;
      document.getElementById('pdf-preview').src = URL.createObjectURL(file);
      const form = new FormData(); form.append('file', file);
      fetch('/upload',{method:'POST',body:form})
        .then(res=>res.json()).then(fillData);
    }

    function fillData(data){
      document.getElementById('nome').value = data.nome;
      document.getElementById('cpf').value = data.cpf;
      document.getElementById('cidade').value = data.cidade;
      document.getElementById('cep').value = data.cep;
      document.getElementById('rua').value = data.rua;
      document.getElementById('numero').value = data.numero;
      document.getElementById('media').value = data.consumo_medio;
      drawChart(data.consumos);
      document.getElementById('timestamp').textContent = 'Atualizado em: ' + data.timestamp;
    }

    let chartInstance;
    function drawChart(vals){
      const ctx = document.getElementById('chart').getContext('2d');
      const monthNames = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
      let labels = [];
      const now = new Date();
      const N = vals.length;
      for(let i=0; i< N; i++){
        const d = new Date(now.getFullYear(), now.getMonth() - (N-1-i), 1);
        labels.push(monthNames[d.getMonth()]);
      }
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Consumo (kWh)', data:vals, backgroundColor:'#3f83f8' }] },
        options:{ plugins:{
            datalabels:{ align:'end', anchor:'end', formatter: v => v }
          },
          scales:{ y:{ beginAtZero:true } }
        },
        plugins:[ChartDataLabels]
      });
    }
  </script>
</body>
</html>